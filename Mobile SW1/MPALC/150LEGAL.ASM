LIST P=16C84
;
COMWRIN		EQU 	B'10100000'
COMRDIN		EQU	B'10100001'
ADDRIN		EQU	B'10110000'

COMWROUT	EQU	B'10101100'
ADDR1		EQU	B'11001101'
ADDR2		EQU	B'11001110'
ADDR3		EQU	B'11001111'
ADDR4		EQU	B'11010000'

SNWROUT		EQU	B'10101110'
ADDRSN		EQU	8Ch		;ADRESS SEREAL NO.

ADDRSYS		EQU	0D2h		;ADRESS SYS CODE,MAST BE USED WITH COMWROUT


;	PARAMETRS LEGAL
LDAT1		EQU	43h	;1&2 DIGITS OF NOMER
LDAT2		EQU	43h
LDAT3		EQU	56h
LDAT4		EQU	90h	;7&8 DIGITS OF NOMER

LSYS		EQU	77h	;LEGAL 2&3 DIGITS OF SYS CODE
NSYS		EQU	15h	;NOT LEGAL 2&3 DIGITS OF SYS CODE

LSENO		EQU 	36h	;LEGAL DIGIT OF SEREAL NOMER 
NSENO		EQU	31h	;NOT LEGAL DIGIT OF SER. NO.


STATUS		EQU	03h
PORTB		EQU	06h
TRISB		EQU	06h

EEDATA		EQU	08h
EEADR		EQU	09h
EECON1		EQU	08h
EECON2		EQU	09h

WRB		EQU	0Ch
REB		EQU	0Dh
CNTCIKL		EQU	0Eh
TIME		EQU	0Fh
TIME2		EQU	10H

DATA1		EQU	11h
DATA2		EQU	12h
DATA3		EQU	13h
DATA4		EQU	14h

SYS		EQU	15h
SENO		EQU	16h




;
	ORG	0
	CLRF	PORTB

	MOVLW	0		;USER ADRESS OF EEPROM
	MOVWF	EEADR
	CALL	EERD
	BTFSC	EEDATA,0	;IF BIT IN EEDATA = 0 THEN DISABLE REFERENS COD
	GOTO	CONCON		;ELSE CONTINUE
	CALL	CLDREF		;RESET BIT OF PORT
	CALL	CLDREF	


CONCON	CALL	BEGIN
	CALL	START
	MOVLW	COMWRIN
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDRIN
	MOVWF	WRB
	CALL	OUTI2C
	CALL	START
	MOVLW	COMRDIN
	MOVWF	WRB
	CALL	OUTI2C
	CALL	INI2C
	MOVF	REB,0
	MOVWF	DATA1
	CALL	INI2C
	MOVF	REB,0
	MOVWF	DATA2
	CALL	INI2C
	MOVF	REB,0
	MOVWF	DATA3
	CALL	INI2C
	MOVF	REB,0
	MOVWF	DATA4
	CALL	STOP
	CALL	TM		;END PROC READING 24C16

	MOVLW	0
	MOVWF	EEADR

	BTFSC	DATA1,0
	GOTO	NLEG
	BTFSC	DATA1,1
	GOTO	NLEG
	BTFSC	DATA1,2
	GOTO	NLEG
	BTFSC	DATA1,3
	GOTO	NLEG
	BTFSC	DATA1,4
	GOTO	NLEG
	BTFSC	DATA1,5
	GOTO	NLEG
	BTFSC	DATA1,6
	GOTO	NLEG
	BTFSC	DATA1,7
	GOTO	NLEG
	GOTO	LEG	

NLEG	MOVLW	0		;WRITE EEPROM NOT LEGAL
	MOVWF	EEADR
	MOVWF	EEDATA
	CALL	EEWR
	MOVLW	NSYS
	MOVWF	SYS
	MOVLW	NSENO
	MOVWF	SENO
	GOTO	CONWR
	
LEG	MOVLW	0		;WRITE EEPROM LEGAL
	MOVWF	EEADR
	MOVLW	0FFh
	MOVWF	EEDATA
	CALL	EEWR

	MOVLW	LDAT1
	MOVWF	DATA1

	MOVLW	LDAT2
	MOVWF	DATA2

	MOVLW	LDAT3
	MOVWF	DATA3

	MOVLW	LDAT4
	MOVWF	DATA4
	
	MOVLW	LSYS
	MOVWF	SYS

	MOVLW	LSENO
	MOVWF	SENO

	
CONWR	CALL	START		;--------------WRITE SYS CODE-----------
	MOVLW	COMWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDRSYS
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	SYS,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP

	CALL	TM

	CALL	START
	MOVLW	COMWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDRSYS
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	SYS,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP

	CALL	TM
;------------------------------------WRITE SER. NOM.-------------------
	CALL	START
	MOVLW	SNWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDRSN
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	SENO,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP
	
	CALL	TM

	CALL	START
	MOVLW	SNWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDRSN
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	SENO,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP
;
;-------------------------------WRITE TEL NO.-------------------

	CALL	START
	MOVLW	COMWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDR1
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	DATA1,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP

	CALL	TM

	CALL	START
	MOVLW	COMWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDR2
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	DATA2,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP

	CALL	TM

	CALL	START
	MOVLW	COMWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDR3
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	DATA3,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP
	
	CALL	TM

	CALL	START
	MOVLW	COMWROUT		
	MOVWF	WRB
	CALL	OUTI2C
	MOVLW	ADDR4
	MOVWF	WRB
	CALL	OUTI2C
	MOVF	DATA4,0
	MOVWF	WRB
	CALL	OUTI2C
	CALL	STOP

	
	GOTO	$

;--------------------------------------------------------------MAIN

OUTI2C	MOVLW	8
	MOVWF	CNTCIKL
CONOUT	BTFSC	WRB,7
	CALL	SETDAT
	CALL	TM
	CALL	SETSTR
	CALL	TM	
	CALL	CLDSTR
	CALL	TM
	CALL	CLDDAT
	RLF	WRB,1
	DECFSZ	CNTCIKL,1
	GOTO	CONOUT
	
	CALL	SETDAT
	CALL	TM
	CALL	SETSTR
	CALL	TM	
	CALL	CLDSTR
	CALL	TM
	CALL	CLDDAT
	CALL	TM
	RETURN
;--------OUT-------------------------------------------------OUT----------
INI2C	CLRF	REB
	MOVLW	8
	MOVWF	CNTCIKL
	CALL	SETDAT
	CALL	TM
	
CONIN	RLF	REB,1
	CALL	SETSTR
	CALL	TM
	BTFSC	PORTB,0
	BSF	REB,0		;WRITE LOW BIT TO REB
	CALL	CLDSTR
	CALL	TM
	DECFSZ	CNTCIKL,1
	GOTO	CONIN
	CALL	CLDDAT
	CALL	TM
	CALL	SETSTR	
	CALL	TM
	CALL	CLDSTR
	CALL	TM
	RETURN
;----------------IN------------------------------------------------IN-------

CLDREF	MOVLW	32		;DISABLE REFERENS CODE (BIT OF PORT = 0)
	MOVWF	STATUS
	BCF	TRISB,3		;USER PORT
	MOVLW	0
	MOVWF	STATUS
	RETURN


SETSTR	MOVLW	32
	MOVWF	STATUS
	BSF	TRISB,1
	MOVLW	0
	MOVWF	STATUS
	RETURN

CLDSTR	MOVLW	32
	MOVWF	STATUS
	BCF	TRISB,1
	MOVLW	0
	MOVWF	STATUS
	RETURN

SETDAT	MOVLW	32
	MOVWF	STATUS
	BSF	TRISB,0
	MOVLW	0
	MOVWF	STATUS
	RETURN

CLDDAT	MOVLW	32
	MOVWF	STATUS
	BCF	TRISB,0
	MOVLW	0
	MOVWF	STATUS
	RETURN
;-----------------PORT-------------------------------------------------------
BEGIN	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
	CALL	TMLONG
BEGI	CALL	TMLONG

	MOVLW	0FFh
	MOVWF	CNTCIKL
CONBEG	CALL	TM
	BTFSC	PORTB,2
	GOTO	BEGI
	DECFSZ	CNTCIKL,1
	GOTO	CONBEG
	RETURN
;-------------------BEGIN----------------------------------------------------
START	CALL	SETDAT
	CALL	TM
	CALL	SETSTR
	CALL	TM
	CALL	CLDDAT
	CALL	TM
	CALL	CLDSTR
	CALL	TM
	RETURN
;-------------------START---------------------------------------------------
STOP	CALL	SETSTR
	CALL	TM
	CALL	SETDAT
	CALL	TM
	RETURN
;---------------------STOP---------------------------------------------------	
TM	MOVLW	7fh
	MOVWF	TIME
LL3	DECFSZ	TIME,1
	GOTO	LL3
	RETURN
;----------------------TM----------------------------------------------------


TMLONG	MOVLW	0FFH
	MOVWF	TIME
LL1	MOVLW	0FFH
	MOVWF	TIME2
LL2	DECFSZ	TIME2,1
	GOTO	LL2	

	DECFSZ	TIME,1
	GOTO	LL1
	RETURN	
;----------------------TMLONG-----------------------------------------------

;	MOVLW	10
;	MOVWF	EEADR
;	CALL	EERD
;	CALL	OUTP	
;	INCF	EEDATA,1
;	CALL	EEWR
;	CALL	END1


;OUTP	MOVLW	MMM1
;	MOVWF	STATUS
;
;	MOVLW	INITA
;	MOVWF	TRISA
;	MOVLW	INITB
;	MOVWF	TRISB
;	MOVLW	MMM2
;	MOVWF	STATUS
;
;	MOVF	EEDATA,0
 ; 	MOVWF	DATAPORT 	;записать W в поpт B (DATAPORT)
;	RETURN	
;
;END1	GOTO	$         	;зациклиться навсегда
;
;
;------------------------------------------READ EEPROM PIC-------------------
;
EERD	MOVLW	32
	MOVWF	STATUS	
	BSF	EECON1,0
	MOVLW	0
	MOVWF	STATUS
	RETURN

;------------------------------------------WRITE EEPROM PIC------------------
EEWR	MOVLW	32
	MOVWF	STATUS
	BSF	EECON1,2
	MOVLW	55h
	MOVWF	EECON2
	MOVLW	0AAh
	MOVWF	EECON2
	BSF	EECON1,1
	MOVLW	0
	MOVWF	STATUS
	RETURN



end
;          
